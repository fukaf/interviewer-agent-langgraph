<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Loading spinner CSS -->
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .recording-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">AI Interview Assistant</h1>
                <p class="text-gray-600">Upload your resume and start your interview</p>
            </div>

            <!-- Initial Upload Section -->
            <div v-if="!sessionStarted" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <form @submit.prevent="startInterview" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Upload Resume (PDF)</label>
                        <input type="file" 
                               @change="handleFileUpload" 
                               accept=".pdf"
                               :disabled="isLoading"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Job Title</label>
                        <input type="text" 
                               v-model="jobTitle"
                               :disabled="isLoading"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" 
                            :disabled="isLoading"
                            class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 flex items-center justify-center">
                        <span v-if="isLoading" class="spinner mr-2"></span>
                        {{ isLoading ? 'Starting Interview...' : 'Start Interview' }}
                    </button>
                </form>
            </div>

            <!-- Interview Section -->
            <div v-if="sessionStarted && !interviewComplete" class="bg-white rounded-lg shadow-md p-6">
                <div class="space-y-4">
                    <!-- Chat Messages -->
                    <div class="space-y-4 mb-4 h-96 overflow-y-auto" ref="chatContainer">
                        <div v-for="(message, index) in messages" 
                             :key="index" 
                             :class="{'text-right': message.isUser}">
                            <div :class="[
                                'inline-block p-4 rounded-lg max-w-3xl',
                                message.isUser ? 'bg-indigo-100 text-left' : 'bg-gray-100'
                            ]">
                                <p class="text-gray-800">{{ message.content }}</p>
                            </div>
                        </div>
                        <div v-if="isTyping" class="flex items-center space-x-2 text-gray-500">
                            <span class="spinner"></span>
                            <span>Interviewer is typing...</span>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="space-y-4">
                        <form @submit.prevent="sendMessage" class="flex gap-2">
                            <input type="text" 
                                   v-model="userInput"
                                   :disabled="isTyping || isRecording"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="Type your response...">
                            
                            <!-- Voice Recording Button -->
                            <button type="button"
                                    @click="toggleRecording"
                                    :disabled="isTyping"
                                    :class="[
                                        'px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2',
                                        isRecording ? 'bg-red-600 hover:bg-red-700 recording-pulse' : 'bg-blue-600 hover:bg-blue-700'
                                    ]"
                                    class="text-white">
                                <span v-if="isRecording">Recording...</span>
                                <span v-else>ðŸŽ¤</span>
                            </button>
                            
                            <button type="submit" 
                                    :disabled="isTyping || isRecording"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50">
                                Send
                            </button>
                        </form>
                        
                        <!-- Get Feedback Button -->
                        <button @click="getFeedback" 
                                :disabled="isTyping || gettingFeedback"
                                class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 flex items-center justify-center">
                            <span v-if="gettingFeedback" class="spinner mr-2"></span>
                            {{ gettingFeedback ? 'Generating Feedback...' : 'Get Interview Feedback' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div v-if="interviewComplete" class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Interview Feedback</h2>
                <div class="prose max-w-none" v-html="renderedFeedback"></div>
                <button @click="resetInterview" 
                        class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Start New Interview
                </button>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    sessionStarted: false,
                    interviewComplete: false,
                    sessionId: null,
                    selectedFile: null,
                    jobTitle: '',
                    messages: [],
                    userInput: '',
                    feedback: '',
                    isLoading: false,
                    isTyping: false,
                    gettingFeedback: false,
                    isRecording: false,
                    recognition: null,
                    audioQueue: [],
                    isPlaying: false,
                    interimTranscript: '',
                    finalTranscript: '',
                    autoListening: false,
                    silenceTimer: null,
                    SILENCE_DURATION: 2000 // 2 seconds of silence before sending
                }
            },
            computed: {
                renderedFeedback() {
                    return marked.parse(this.feedback)
                }
            },
            methods: {
                handleFileUpload(event) {
                    this.selectedFile = event.target.files[0]
                },
                async startInterview() {
                    if (!this.selectedFile || !this.jobTitle) {
                        alert('Please provide both resume and job title')
                        return
                    }

                    this.isLoading = true
                    const formData = new FormData()
                    formData.append('resume', this.selectedFile)
                    formData.append('job_title', this.jobTitle)

                    try {
                        const response = await axios.post('/api/upload', formData)
                        this.sessionId = response.data.session_id
                        this.messages.push({
                            content: response.data.initial_analysis,
                            isUser: false
                        })

                        this.sessionStarted = true
                        
                        // Play the initial message and start listening
                        if (response.data.audio) {
                            await this.playAudio(response.data.audio);
                            this.startContinuousListening();
                        } else {
                            this.startContinuousListening();
                        }
                        
                        
                    } catch (error) {
                        alert('Error starting interview: ' + error.message)
                    } finally {
                        this.isLoading = false
                    }
                },
                initializeSpeechRecognition() {
                    if (!this.recognition) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        this.recognition = new SpeechRecognition();
                        this.recognition.continuous = true;
                        this.recognition.interimResults = true;
                        
                        this.recognition.onresult = (event) => {
                            this.interimTranscript = '';
                            this.finalTranscript = '';
                            
                            for (let i = event.resultIndex; i < event.results.length; i++) {
                                const transcript = event.results[i][0].transcript;
                                
                                if (event.results[i].isFinal) {
                                    this.finalTranscript = transcript;
                                    this.resetSilenceTimer();
                                } else {
                                    this.interimTranscript = transcript;
                                }
                            }
                            
                            // Update the input field in real-time
                            this.userInput = this.finalTranscript || this.interimTranscript;
                        };
                        
                        this.recognition.onend = () => {
                            if (this.autoListening && !this.isTyping) {
                                this.recognition.start();
                            } else {
                                this.isRecording = false;
                                this.autoListening = false;
                            }
                        };
                    }
                },
                startContinuousListening() {
                    this.initializeSpeechRecognition();
                    this.autoListening = true;
                    this.isRecording = true;
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.error('Error starting continuous listening:', error);
                    }
                },
                stopContinuousListening() {
                    this.autoListening = false;
                    if (this.recognition) {
                        this.recognition.stop();
                    }
                    this.isRecording = false;
                    clearTimeout(this.silenceTimer);
                },
                resetSilenceTimer() {
                    clearTimeout(this.silenceTimer);
                    this.silenceTimer = setTimeout(() => {
                        if (this.finalTranscript && !this.isTyping) {
                            this.userInput = this.finalTranscript;
                            this.sendMessage();
                            this.finalTranscript = '';
                            this.interimTranscript = '';
                        }
                    }, this.SILENCE_DURATION);
                },
                async playAudio(audioData) {
                    if (!audioData) return null;
                    
                    return new Promise((resolve) => {
                        const audio = new Audio(audioData);
                        audio.onended = () => {
                            this.isPlaying = false;
                            resolve();
                        };
                        audio.onerror = () => {
                            console.error('Error playing audio');
                            this.isPlaying = false;
                            resolve();
                        };
                        this.isPlaying = true;
                        audio.play().catch(error => {
                            console.error('Error playing audio:', error);
                            this.isPlaying = false;
                            resolve();
                        });
                    });
                },
                async sendMessage() {
                    if (!this.userInput.trim()) return

                    const userMessage = this.userInput
                    this.messages.push({
                        content: userMessage,
                        isUser: true
                    })
                    this.userInput = ''
                    this.isTyping = true
                    this.stopContinuousListening();

                    try {
                        const response = await axios.post('/api/interview', {
                            session_id: this.sessionId,
                            message: userMessage
                        })

                        this.messages.push({
                            content: response.data.response,
                            isUser: false
                        })
                        this.isTyping = false
                        // Wait for audio to finish playing before starting listening again
                        await this.playAudio(response.data.audio);
                        this.startContinuousListening();

                    } catch (error) {
                        alert('Error sending message: ' + error.message)
                    } finally {
                        this.isTyping = false
                    }
                },
                async getFeedback() {
                    this.gettingFeedback = true
                    try {
                        const response = await axios.post('/api/feedback', {
                            session_id: this.sessionId
                        })
                        this.feedback = response.data.feedback
                        this.interviewComplete = true
                    } catch (error) {
                        alert('Error getting feedback: ' + error.message)
                    } finally {
                        this.gettingFeedback = false
                    }
                },
                resetInterview() {
                    this.sessionStarted = false
                    this.interviewComplete = false
                    this.sessionId = null
                    this.selectedFile = null
                    this.jobTitle = ''
                    this.messages = []
                    this.feedback = ''
                    this.isLoading = false
                    this.isTyping = false
                    this.gettingFeedback = false
                },
                async toggleRecording() {
                    if (this.isRecording) {
                        this.stopContinuousListening();
                    } else {
                        this.startContinuousListening();
                    }
                }
            },
            updated() {
                if (this.$refs.chatContainer) {
                    this.$refs.chatContainer.scrollTop = this.$refs.chatContainer.scrollHeight
                }
            },
            mounted() {
                // Check if browser supports speech recognition
                if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                    console.warn('Speech recognition is not supported in this browser');
                }
            }
        }).mount('#app')
    </script>
</body>
</html> 